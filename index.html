
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Thu ti·ªÅn ƒëi·ªán</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    input, button, textarea { margin: 5px; padding: 5px; }
    #hoaDon {
      width: 400px;
      min-height: 250px;
      border: 2px solid black;
      padding: 15px;
      white-space: pre-wrap;
      font-size: 16px;
      font-family: 'Courier New', monospace;
      line-height: 1.6;
    }
    .row { display: flex; align-items: center; margin-bottom: 10px; }
    .label { width: 150px; }
    #lichSuIn, #lichSuThu { width: 300px; height: 100px; margin: 5px; }
  </style>
</head>
<body>

<h2>Thu ti·ªÅn ƒëi·ªán</h2>

<div class="row">
  <label class="label">M√£ kh√°ch h√†ng</label>
  <input list="danhSachKH" id="maKH" placeholder="(m·ª•c t√¨m ki·∫øm)">
  <datalist id="danhSachKH"></datalist>
  <button onclick="timKiemMaKH()">üîç</button>
</div>

<div class="row">
  <label class="label">T√¨m theo t√™n KH</label>
  <input id="tenKHInput" placeholder="Nh·∫≠p t√™n KH">
  <button onclick="timKiemTenKH()">üîç</button>
</div>

<div class="row">
  <label class="label">S·ªë ti·ªÅn</label>
  <input id="soTien" readonly>
</div>

<div class="row">
  <label class="label">T√™n KH</label>
  <input id="tenKH" readonly>
</div>

<div>
  <div id="hoaDon">[H√≥a ƒë∆°n s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y]</div>
  <button onclick="inHoaDon()">In</button>
  <button onclick="xacNhanThu()" style="border:2px solid black;">x√°c nh·∫≠n ƒë√£ thu</button>
</div>

<div class="row">
  <button onclick="document.getElementById('fileInput').click()">ƒê·∫©y d·ªØ li·ªáu</button>
  <input type="file" id="fileInput" accept=".xlsx" style="display:none" onchange="docFileExcel(event)">
</div>

<div class="row">
  <div>
    <label>L·ªãch s·ª≠ in</label><br>
    <textarea id="lichSuIn" readonly></textarea><br>
    <button onclick="xuatLichSu('in')">Xu·∫•t l·ªãch s·ª≠</button>
  </div>
  <div>
    <label><b>l·ªãch s·ª≠ thu</b></label><br>
    <textarea id="lichSuThu" readonly></textarea><br>
    <button onclick="xuatLichSu('thu')">Xu·∫•t l·ªãch s·ª≠</button>
  </div>
</div>

<button onclick="xuatLichSuExcel()">Xu·∫•t Excel</button>

<script>
let duLieu = [];
let lichSuIn = JSON.parse(localStorage.getItem("lichSuIn")) || [];
let lichSuThu = JSON.parse(localStorage.getItem("lichSuThu")) || [];

function formatVND(number) {
  return Number(number).toLocaleString('vi-VN') + ' ‚Ç´';
}

function timKiemMaKH() {
  const maKH = document.getElementById("maKH").value.trim();
  const kh = duLieu.find(row => row.MA_KHTT === maKH);
  if (kh) {
    document.getElementById("tenKH").value = kh.TEN_KHTT;
    document.getElementById("soTien").value = kh.TONG_NOP;
  }
}

function timKiemTenKH() {
  const tenKH = document.getElementById("tenKHInput").value.trim().toLowerCase();
  const kh = duLieu.find(row => row.TEN_KHTT.toLowerCase().includes(tenKH));
  if (kh) {
    document.getElementById("maKH").value = kh.MA_KHTT;
    document.getElementById("tenKH").value = kh.TEN_KHTT;
    document.getElementById("soTien").value = kh.TONG_NOP;
  }
}

function inHoaDon() {
  const maKH = document.getElementById("maKH").value;
  const tenKH = document.getElementById("tenKH").value;
  const soTien = Number(document.getElementById("soTien").value || 0);
  const phi = 2000;
  const tong = soTien + phi;
  const thoiGian = new Date().toLocaleDateString('vi-VN');

  const noiDung = `BI√äN NH·∫¨N THANH TO√ÅN TI·ªÄN ƒêI·ªÜN

M√£ KH: ${maKH}
T√™n KH: ${tenKH}
S·ªë Ti·ªÅn: ${formatVND(soTien)}
Ph√≠: ${formatVND(phi)}
T·ªïng Ti·ªÅn: ${formatVND(tong)}

ƒê√É THANH TO√ÅN
Ng√†y ${thoiGian}`;

  document.getElementById("hoaDon").innerText = noiDung;

  lichSuIn.push({ maKH, tenKH, soTien: tong, thoiGian });
  localStorage.setItem("lichSuIn", JSON.stringify(lichSuIn));
  capNhatLichSu();
}

function xacNhanThu() {
  const maKH = document.getElementById("maKH").value;
  const tenKH = document.getElementById("tenKH").value;
  const soTien = Number(document.getElementById("soTien").value || 0) + 2000;
  const thoiGian = new Date().toLocaleString();

  lichSuThu.push({ maKH, tenKH, soTien, thoiGian });
  localStorage.setItem("lichSuThu", JSON.stringify(lichSuThu));
  capNhatLichSu();
}

function capNhatLichSu() {
  const inText = lichSuIn.map(item => `(${item.thoiGian}) ${item.maKH} - ${item.tenKH}: ${formatVND(item.soTien)}`).join("\n");
  const thuText = lichSuThu.map(item => `(${item.thoiGian}) ${item.maKH} - ${item.tenKH}: ${formatVND(item.soTien)}`).join("\n");
  document.getElementById("lichSuIn").value = inText;
  document.getElementById("lichSuThu").value = thuText;
}

function xuatLichSu(loai) {
  const duLieu = loai === 'in' ? lichSuIn : lichSuThu;
  const text = duLieu.map(item => `(${item.thoiGian}) ${item.maKH} - ${item.tenKH}: ${item.soTien}`).join("\n");
  const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `lich_su_${loai}.txt`;
  a.click();
}

function xuatLichSuExcel() {
  const ws = XLSX.utils.json_to_sheet([...lichSuIn.map(e => ({ ...e, Loai: 'In' })), ...lichSuThu.map(e => ({ ...e, Loai: 'Thu' }))]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "LichSu");
  XLSX.writeFile(wb, "lich_su.xlsx");
}

function docFileExcel(event) {
  const file = event.target.files[0];
  const reader = new FileReader();
  reader.onload = (e) => {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: "array" });
    const sheetName = workbook.SheetNames[0];
    const sheet = workbook.Sheets[sheetName];
    duLieu = XLSX.utils.sheet_to_json(sheet);
    const dataList = document.getElementById("danhSachKH");
    dataList.innerHTML = "";
    duLieu.forEach(row => {
      const option = document.createElement("option");
      option.value = row.MA_KHTT;
      dataList.appendChild(option);
    });
  };
  reader.readAsArrayBuffer(file);
}

window.onload = capNhatLichSu;
</script>

</body>
</html>
